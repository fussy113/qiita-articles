---
title: ActionMailerに、複数のメールを一括でエンキューするメソッドが追加された
tags:
  - Ruby
  - Rails
  - tips
private: false
updated_at: '2025-12-16T07:06:26+09:00'
id: 9a12549f6a5786d735e8
organization_url_name: null
slide: false
ignorePublish: false
---
## はじめに

```ruby:app/mailers/test_mailer.rb
class TestMailer < ApplicationMailer
  def sample_email(user)
    @user = user
    mail(to: @user.email_address, subject: 'Sample Email')
  end
end
```

```ruby:app/jobs/delivery_test_mailer_job.rb

class TestMailerBulkSendJob < ApplicationJob
    def perform
        users = User.all # ここは適当な条件

        # メールをエンキューする処理 
    end
end
```

上記のように、メールを複数件送信する場合、エンキューする処理をどのように書きますか？
こんな方法あるよなを書きつつ、Rails8.1で追加されたメソッドについて紹介します。

## 書き方

### 素直にループしてキューイングする

```ruby:app/jobs/delivery_test_mailer_job.rb

class TestMailerBulkSendJob < ApplicationJob
    def perform
        users = User.all # ここは適当な条件

        users.each do |user|
            TestMailer.sample_email(user).deliver_later
        end
    end
end
```

シンプルですね。
件数が数千件になってくると、1件ずつエンキューするのはパフォーマンス的に影響が出てきそうです。

## ActiveJob.perform_all_later を利用する

Rails 7.1にて追加されたActiveJob.perform_all_later を使って、複数件のメールを一括でエンキューすることができます。

```ruby:app/jobs/delivery_test_mailer_job.rb

class TestMailerBulkSendJob < ApplicationJob
    def perform
        users = User.all # ここは適当な条件

        delivery_jobs = []

        users.each do |user|
            delivery_jobs << ActionMailer::MailDeliveryJob.new(
                'TestMailer',
                'sample_email',
                'deliver_now',
                args: [admin_user]
            )
        end

        ActiveJob.perform_all_later(delivery_jobs)
    end
end
```

ActionMailer::MailDeliveryJobのObjectを明示して生成する必要があるため、若干の冗長さがあります。

### ActionMailer.deliver_all_later を利用する

Rails8.1からは、以下のように書くことができるようになりました。

```ruby:app/jobs/delivery_test_mailer_job.rb
class TestMailerBulkSendJob < ApplicationJob
    def perform
        users = User.all # ここは適当な条件

        deliveries = []

        users.each { |user| deliveries << TestMailer.sample_email(user) }

        ActionMailer.deliver_all_later(deliveries)
    end
end
```

実装を見てみると、`ActiveJob.perform_all_later` を使っていて、前述した書き方のラッパーのようなイメージです。
パフォーマンス的には大きく変わることはなさそうですが、だいぶスッキリかけるようになった印象があります。

https://github.com/rails/rails/blob/69763325dd86f839a58e2096785b31a66b763378/actionmailer/lib/action_mailer/message_delivery.rb#L25-L34

ActionMailerを使っていて、大量件数のメール送信をしている箇所があれば、積極的に使っていきたいです。
