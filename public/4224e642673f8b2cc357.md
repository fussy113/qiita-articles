---
title: 後からnormalizesしたカラムの古いデータを更新する
tags:
  - Ruby
  - Rails
  - tips
private: false
updated_at: '2025-12-10T23:36:13+09:00'
id: 4224e642673f8b2cc357
organization_url_name: null
slide: false
ignorePublish: false
---
Rails7.1で、属性値を正規化するための normalizesが追加された。
すでにアプリケーションで利用しているテーブルのカラムに対して、normalizesを設定した時、それまでのレコードのデータは特に更新されない。
`#normalize_attribute` などを使って、明示的に正規化をした上で、save等を行う必要がある。

```ruby
class User
  include ActiveModel::Attributes
  include ActiveModel::Attributes::Normalization

  attribute :email, :string

  normalizes :email, with: -> email { email.strip.downcase }
end

legacy_user.email # => " CRUISE-CONTROL@EXAMPLE.COM\n"
legacy_user.normalize_attribute(:email)
legacy_user.email # => "cruise-control@example.com"
```

https://github.com/rails/rails/blob/01e5a0c65d012baede7f2084615a0c7a8b294ae9/activemodel/lib/active_model/attributes/normalization.rb#L70-L73

その属性値を再代入をするようになっている。
